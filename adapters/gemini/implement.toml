description = "Execute implementation plan with rigorous validation loops"
prompt = """# PRP Implement — Execute Plan

Plan: {{args}}

## Mission

Execute the plan end-to-end autonomously. Validate after every change. Fix before moving on.

## Steps

1. **Detect Environment**: Package manager from lock files (bun/pnpm/yarn/npm/uv/cargo/go). Validation scripts from config. Use plan's "Validation Commands".
2. **Load Plan**: Read plan, extract: Summary, Patterns to Mirror, Files to Change, Tasks, Validation Commands, Acceptance Criteria. If not found: STOP.
3. **Prepare Git**: Check branch + worktree state. In worktree → use it. On main clean → create branch. On main dirty → STOP. On feature → use it. Sync: `git fetch origin && git pull --rebase origin main 2>/dev/null || true`
4. **Execute Tasks**: For each task — read MIRROR reference, implement exactly as specified, **validate immediately** (type-check after EVERY change), track progress, document deviations (WHAT and WHY).
5. **Full Validation**:
   - Static: type-check + lint (zero errors). Lint fix → re-check → manual fix.
   - Tests: MUST write/update tests. If fail: determine root cause → fix → re-run until green.
   - Build: must succeed.
   - Integration (if applicable): start server → test endpoints → stop server.
   - Edge cases from plan.
6. **Report**: Save to `.prp-output/reports/{name}-report-gemini.md` with: assessment vs reality, tasks completed, validation results, files changed, deviations, issues, tests written. Uses `-gemini` suffix to identify Gemini implementation reports and prevent overwriting reports from other tools.
7. **Generate Review Context** (for run-all workflow): Save to `.prp-output/reviews/pr-context-{BRANCH}.md` with: branch, files changed, implementation summary, validation status, key changes for review, focus areas. Saves ~60K tokens when running via run-all.
8. **PRD Update** (if applicable): Change phase status from `in-progress` to `complete`.
9. **Archive**: Move plan to `.prp-output/plans/completed/`
10. **Output**: Status, validation summary, files changed, deviations, artifacts (including review context), PRD progress (if applicable), next steps.

## Success Criteria

- All plan tasks executed
- Type-check, lint, tests, build all pass
- Implementation report created
- Review context file created
- PRD updated (if applicable)
- Plan archived

## Failure Handling

- Type-check fails → read error, fix, re-run, don't proceed until passing
- Tests fail → determine implementation or test bug, fix root cause, re-run
- Lint fails → run lint fix, manually fix remaining
- Build fails → check error, fix, re-run
- Integration fails → check server, verify endpoint, fix, retry
"""
